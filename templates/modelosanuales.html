<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dynamic Balance Sheet</title>

  <!-- Tailwind (CDN for utility classes) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.js" defer></script>

  <!-- App styles -->
  <link rel="stylesheet" href="styles.css" />
  
  <style>
    /* Additional scrollable inventory lists styles */
    .inventory-scroll {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.05);
      padding: 8px;
    }

    .scroll-controls {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 12px;
    }

    .scroll-btn {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 8px;
      padding: 8px 16px;
      color: var(--primary-blue);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 12px;
    }

    .scroll-btn:hover {
      background: rgba(59, 130, 246, 0.2);
      transform: translateY(-1px);
    }

    .scroll-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .item-count {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 8px;
      text-align: center;
      font-weight: 500;
      padding: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      margin: 8px 0 16px 0;
    }

    .inventory-item {
      margin: 8px 0;
    }

    /* Scrollable inventory details panels */
    .details-panel {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      margin-top: 12px;
      transition: all 0.3s ease;
    }

    .details-panel::-webkit-scrollbar {
      width: 6px;
    }

    .details-panel::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
    }

    .details-panel::-webkit-scrollbar-thumb {
      background: rgba(59, 130, 246, 0.5);
      border-radius: 3px;
    }

    .details-panel::-webkit-scrollbar-thumb:hover {
      background: rgba(59, 130, 246, 0.7);
    }

    .details-content {
      padding: 12px;
    }

    .details-scroll-controls {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 8px;
      padding: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 6px;
    }

    .details-scroll-btn {
      background: rgba(59, 130, 246, 0.15);
      border: 1px solid rgba(59, 130, 246, 0.25);
      border-radius: 6px;
      padding: 4px 12px;
      color: var(--primary-blue);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 11px;
    }

    .details-scroll-btn:hover {
      background: rgba(59, 130, 246, 0.25);
      transform: translateY(-1px);
    }

    .item-details-table {
      width: 100%;
      font-size: 0.8rem;
    }

    .item-details-table th {
      background: rgba(255, 255, 255, 0.1);
      padding: 8px;
      text-align: left;
      font-weight: 600;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .item-details-table td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-7xl mx-auto p-6">
    <h1 class="main-title text-5xl font-bold text-center mb-12 floating">Dynamic Balance Sheet</h1>

    <!-- API Status -->
    <div id="api-status" class="mb-8 p-4 rounded-2xl text-center glass-card status-loading" role="status" aria-live="polite">
      <span class="loading" aria-hidden="true"></span>
      <span class="ml-2 font-medium">Connecting to API...</span>
    </div>

    <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
      <!-- Assets -->
      <div class="glass-card p-8">
        <h2 class="assets-header section-header text-3xl font-bold mb-8 pb-4">Assets</h2>
        
        <!-- Scrollable Assets List -->
        <div class="inventory-scroll">
          <div class="item-count" id="assets-count">Loading assets...</div>
          <div id="assets-list" class="space-y-2"></div>
        </div>
        
        <!-- Scroll Controls for Assets -->
        <div class="scroll-controls">
          <button class="scroll-btn" onclick="scrollToTop('assets-list')">↑ Top</button>
          <button class="scroll-btn" onclick="scrollToBottom('assets-list')">↓ Bottom</button>
        </div>

        <div class="total-assets p-6 rounded-2xl mt-8">
          <div class="flex justify-between items-center">
            <span class="font-bold text-xl text-blue-800">Total Assets</span>
            <span id="total-assets" class="font-bold text-2xl text-blue-900">$0.00</span>
          </div>
        </div>
      </div>

      <!-- Liabilities -->
      <div class="glass-card p-8">
        <h2 class="liabilities-header section-header text-3xl font-bold mb-8 pb-4">Liabilities &amp; Equity</h2>
        
        <!-- Scrollable Liabilities List -->
        <div class="inventory-scroll">
          <div class="item-count" id="liabilities-count">Loading liabilities...</div>
          <div id="liabilities-list" class="space-y-2"></div>
        </div>
        
        <!-- Scroll Controls for Liabilities -->
        <div class="scroll-controls">
          <button class="scroll-btn" onclick="scrollToTop('liabilities-list')">↑ Top</button>
          <button class="scroll-btn" onclick="scrollToBottom('liabilities-list')">↓ Bottom</button>
        </div>

        <div class="total-liabilities p-6 rounded-2xl mt-8">
          <div class="flex justify-between items-center">
            <span class="font-bold text-xl text-red-800">Total Liabilities &amp; Equity</span>
            <span id="total-liabilities" class="font-bold text-2xl text-red-900">$0.00</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Refresh -->
    <div class="text-center mt-12">
      <button id="refresh-btn" type="button" class="btn-primary" aria-label="Refresh data">Refresh Data</button>
    </div>
  </div>

  <!-- Error Modal -->
  <div id="error-modal" class="hidden fixed inset-0 modal-backdrop overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-8 border w-96 modal-content">
      <div class="mt-3">
        <h3 class="text-xl font-semibold text-gray-900 mb-6">⚠️ Error</h3>
        <p id="error-message" class="text-red-600 mb-6 text-base"></p>
        <button type="button" id="close-error" class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-300">Close</button>
      </div>
    </div>
  </div>

  <!-- Add / Edit Accounts Payable Modal -->
  <div id="add-ap-modal" class="hidden fixed inset-0 modal-backdrop overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-8 border w-96 modal-content">
      <div class="mt-3">
        <h3 id="ap-modal-title" class="text-xl font-semibold text-gray-900 mb-6">➕ Add Accounts Payable</h3>
        <form id="add-ap-form">
          <div class="mb-4">
            <label class="form-label" for="ap-fecha">Date</label>
            <input type="date" id="ap-fecha" name="fecha" class="form-input" required>
          </div>
          <div class="mb-4">
            <label class="form-label" for="ap-concept">Concept</label>
            <input type="text" id="ap-concept" name="concept" class="form-input" placeholder="Payment description" required>
          </div>
          <div class="mb-4">
            <label class="form-label" for="ap-rmb">RMB Amount</label>
            <input type="number" id="ap-rmb" name="rmb" class="form-input" step="0.01" placeholder="0.00">
          </div>
          <div class="mb-6">
            <label class="form-label" for="ap-amount">MXN Amount</label>
            <input type="number" id="ap-amount" name="amount" class="form-input" step="0.01" placeholder="0.00">
            <p class="text-xs text-gray-500 mt-1">Provide either RMB or MXN amount. MXN = RMB × 3</p>
          </div>
          <div class="flex gap-3">
            <button type="submit" class="btn-add flex-1">Add Entry</button>
            <button type="button" id="close-add-ap" class="btn-secondary flex-1">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Add / Edit Inventory on Transit Modal -->
  <div id="add-iot-modal" class="hidden fixed inset-0 modal-backdrop overflow-y-auto h-full w-full z-50">
    <div class="relative top-10 mx-auto p-8 border w-[36rem] modal-content">
      <div class="mt-3">
        <h3 class="text-xl font-semibold text-gray-900 mb-6">➕ Add Inventory on Transit</h3>
        <form id="add-iot-form" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label class="form-label">Supplier</label>
              <input type="text" id="iot-supplier" class="form-input" placeholder="Supplier name">
            </div>
            <div>
              <label class="form-label">Estilo</label>
              <input list="estilos-list" id="iot-estilo" class="form-input" placeholder="Type or pick a style">
              <datalist id="estilos-list"></datalist>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div>
              <label class="form-label">Ordenado</label>
              <input type="date" id="iot-ordenado" class="form-input">
            </div>
            <div>
              <label class="form-label">Pagado</label>
              <input type="date" id="iot-pagado" class="form-input">
            </div>
            <div>
              <label class="form-label">Entregado</label>
              <input type="date" id="iot-entregado" class="form-input">
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
            <div>
              <label class="form-label">Qty</label>
              <input type="number" id="iot-qty" class="form-input" step="1" min="0" value="0">
            </div>
            <div>
              <label class="form-label">Carton</label>
              <input type="number" id="iot-carton" class="form-input" step="1" min="0">
            </div>
            <div>
              <label class="form-label">RMB</label>
              <input type="number" id="iot-rmb" class="form-input" step="0.01" min="0" value="0">
            </div>
            <div>
              <label class="form-label">Amount (auto)</label>
              <input type="text" id="iot-amount" class="form-input" disabled>
            </div>
          </div>

          <div>
            <label class="form-label">Notas</label>
            <textarea id="iot-notas" class="form-input" rows="2" placeholder="Notes"></textarea>
          </div>

          <div class="flex gap-3 pt-2">
            <button type="submit" class="btn-add flex-1">Add Entry</button>
            <button type="button" id="close-add-iot" class="btn-secondary flex-1">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- App logic -->
  <script src="app.js"></script>
  
  <!-- Scroll control functions -->
  <script>
    function scrollToTop(containerId) {
      const container = document.getElementById(containerId);
      if (container) {
        const scrollContainer = container.closest('.inventory-scroll');
        if (scrollContainer) {
          scrollContainer.scrollTo({
            top: 0,
            behavior: 'smooth'
          });
        }
      }
    }

    function scrollToBottom(containerId) {
      const container = document.getElementById(containerId);
      if (container) {
        const scrollContainer = container.closest('.inventory-scroll');
        if (scrollContainer) {
          scrollContainer.scrollTo({
            top: scrollContainer.scrollHeight,
            behavior: 'smooth'
          });
        }
      }
    }

    // Update item counts when data loads
    function updateItemCounts() {
      const assetsList = document.getElementById('assets-list');
      const liabilitiesList = document.getElementById('liabilities-list');
      
      if (assetsList) {
        const assetsCount = assetsList.children.length;
        const assetsCountEl = document.getElementById('assets-count');
        if (assetsCountEl) {
          assetsCountEl.textContent = `${assetsCount} asset item${assetsCount !== 1 ? 's' : ''}`;
        }
      }
      
      if (liabilitiesList) {
        const liabilitiesCount = liabilitiesList.children.length;
        const liabilitiesCountEl = document.getElementById('liabilities-count');
        if (liabilitiesCountEl) {
          liabilitiesCountEl.textContent = `${liabilitiesCount} liability item${liabilitiesCount !== 1 ? 's' : ''}`;
        }
      }
    }

    // Call updateItemCounts whenever data is loaded
    // You can integrate this with your existing app.js data loading functions
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize counts
      updateItemCounts();
      
      // Set up a MutationObserver to watch for changes in the lists
      const observer = new MutationObserver(updateItemCounts);
      
      const assetsList = document.getElementById('assets-list');
      const liabilitiesList = document.getElementById('liabilities-list');
      
      if (assetsList) {
        observer.observe(assetsList, { childList: true });
      }
      
      if (liabilitiesList) {
        observer.observe(liabilitiesList, { childList: true });
      }

      // Add click handlers for inventory items to add scroll controls to details
      setupInventoryDetailsScrolling();
    });

    function setupInventoryDetailsScrolling() {
      // Watch for changes in the inventory lists to add scroll controls to new items
      const inventoryObserver = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          mutation.addedNodes.forEach(function(node) {
            if (node.nodeType === 1) { // Element node
              addScrollControlsToInventoryItem(node);
            }
          });
        });
      });

      const assetsList = document.getElementById('assets-list');
      const liabilitiesList = document.getElementById('liabilities-list');
      
      if (assetsList) {
        inventoryObserver.observe(assetsList, { childList: true, subtree: true });
        // Add to existing items
        assetsList.querySelectorAll('.clickable').forEach(addScrollControlsToInventoryItem);
      }
      
      if (liabilitiesList) {
        inventoryObserver.observe(liabilitiesList, { childList: true, subtree: true });
        // Add to existing items
        liabilitiesList.querySelectorAll('.clickable').forEach(addScrollControlsToInventoryItem);
      }
    }

    function addScrollControlsToInventoryItem(item) {
      if (!item.classList || !item.classList.contains('clickable')) return;

      // Add click listener to handle details panel
      item.addEventListener('click', function() {
        setTimeout(function() {
          const detailsPanel = item.querySelector('.details-panel');
          if (detailsPanel && !detailsPanel.querySelector('.details-scroll-controls')) {
            addScrollControlsToDetailsPanel(detailsPanel);
          }
        }, 100); // Wait for the panel to open
      });
    }

    function addScrollControlsToDetailsPanel(detailsPanel) {
      // Create scroll controls container
      const scrollControls = document.createElement('div');
      scrollControls.className = 'details-scroll-controls';
      
      const topBtn = document.createElement('button');
      topBtn.className = 'details-scroll-btn';
      topBtn.innerHTML = '↑ Top';
      topBtn.onclick = function(e) {
        e.stopPropagation();
        detailsPanel.scrollTo({ top: 0, behavior: 'smooth' });
      };
      
      const bottomBtn = document.createElement('button');
      bottomBtn.className = 'details-scroll-btn';
      bottomBtn.innerHTML = '↓ Bottom';
      bottomBtn.onclick = function(e) {
        e.stopPropagation();
        detailsPanel.scrollTo({ top: detailsPanel.scrollHeight, behavior: 'smooth' });
      };

      scrollControls.appendChild(topBtn);
      scrollControls.appendChild(bottomBtn);
      
      // Insert at the beginning of the details panel
      if (detailsPanel.firstChild) {
        detailsPanel.insertBefore(scrollControls, detailsPanel.firstChild);
      } else {
        detailsPanel.appendChild(scrollControls);
      }
    }

    // Enhanced scroll functions for both main lists and details panels
    function scrollDetailsToTop(detailsPanel) {
      if (detailsPanel) {
        detailsPanel.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }

    function scrollDetailsToBottom(detailsPanel) {
      if (detailsPanel) {
        detailsPanel.scrollTo({ top: detailsPanel.scrollHeight, behavior: 'smooth' });
      }
    }
  </script>
</body>
</html>