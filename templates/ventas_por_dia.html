<!-- Replace your chart section in verdetalleestilos.html with this -->

<!-- Charts Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-graph-up-arrow"></i> Tendencia de Ventas por Modelo
                </h5>
            </div>
            <div class="card-body">
                <div style="position: relative; height: 400px;">
                    <canvas id="salesTrendChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Always include the script (remove the conditional) -->
<script>
console.log('=== ANALYTICS CHART DEBUG ===');
console.log('Chart.js available?', typeof Chart !== 'undefined');

// Build data directly from your template data
const rawData = [
    {% if analytics_data and analytics_data.daily_data %}
    {% for row in analytics_data.daily_data %}
    {
        fecha: "{{ row.fecha.strftime('%Y-%m-%d') if row.fecha else '' }}",
        modelo: "{{ row.modelo }}",
        ingresos: {{ row.daily_revenue or 0 }}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
    {% endif %}
];

console.log('Raw data from template:', rawData);

const canvas = document.getElementById('salesTrendChart');
if (!canvas) {
    console.error('Canvas element not found!');
} else if (typeof Chart === 'undefined') {
    console.error('Chart.js not loaded!');
} else if (rawData.length === 0) {
    console.log('No data available');
    canvas.parentElement.innerHTML = '<div class="alert alert-info">No hay datos de ventas disponibles</div>';
} else {
    // Process the data
    const fechasSet = new Set();
    const modelosSet = new Set();
    
    rawData.forEach(item => {
        if (item.fecha) fechasSet.add(item.fecha);
        if (item.modelo) modelosSet.add(item.modelo);
    });
    
    const fechasOrdenadas = Array.from(fechasSet).sort();
    const modelos = Array.from(modelosSet);
    
    console.log('Processed dates:', fechasOrdenadas);
    console.log('Processed models:', modelos);
    
    // Create datasets
    const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];
    const datasets = modelos.map((modelo, index) => {
        const data = fechasOrdenadas.map(fecha => {
            const found = rawData.find(item => item.modelo === modelo && item.fecha === fecha);
            return found ? found.ingresos : 0;
        });
        
        return {
            label: modelo,
            data: data,
            borderColor: colors[index % colors.length],
            backgroundColor: colors[index % colors.length] + '20',
            fill: false,
            tension: 0.4,
            borderWidth: 3,
            pointRadius: 6
        };
    });
    
    console.log('Final datasets:', datasets);
    
    // Create chart
    const chart = new Chart(canvas.getContext('2d'), {
        type: 'line',
        data: {
            labels: fechasOrdenadas,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Tendencia de Ventas por Modelo'
                },
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Ingresos ($)'
                    },
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Fecha'
                    }
                }
            }
        }
    });
    
    console.log('Chart created successfully:', chart);
}
</script>