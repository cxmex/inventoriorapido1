{% extends "base.html" %}

{% block title %}Ventas Semanales (últimas 6 semanas){% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2>Ventas Semanales (últimas 6 semanas)</h2>
                <button class="btn btn-outline-primary" onclick="window.print()">
                    <i class="bi bi-printer"></i> Imprimir
                </button>
            </div>
        </div>
    </div>
    
    <!-- Chart -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">Gráfico de Ventas</h5>
        </div>
        <div class="card-body">
            {% if chart_data and chart_data|length > 0 %}
                <div class="chart-container" style="position: relative; height:400px;">
                    <canvas id="salesChart"></canvas>
                </div>
                <div class="text-center mt-3">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary active" id="barChartBtn">Barras</button>
                        <button type="button" class="btn btn-outline-primary" id="lineChartBtn">Línea</button>
                    </div>
                </div>
            {% else %}
                <div class="alert alert-info">
                    No hay datos disponibles para mostrar en el gráfico.
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Data Table -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">Tabla de Ventas</h5>
        </div>
        <div class="card-body">
            {% if week_totals and week_totals|length > 0 %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Semana que empieza</th>
                                <th class="text-end">Total Ventas</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for fecha, total in week_totals.items() %}
                            <tr>
                                <td>{{ fecha }}</td>
                                <td class="text-end">${{ '%.2f' | format(total) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-secondary">
                            <tr>
                                <th>Total General</th>
                                <th class="text-end">
                                    {% set grand_total = 0 %}
                                    {% for total in week_totals.values() %}
                                        {% set grand_total = grand_total + total %}
                                    {% endfor %}
                                    ${{ '%.2f' | format(grand_total) }}
                                </th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info">
                    No se encontraron datos de ventas para el período seleccionado.
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Summary Card -->
    {% if week_totals and week_totals|length > 0 %}
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0">Resumen</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% set grand_total = 0 %}
                    {% for total in week_totals.values() %}
                        {% set grand_total = grand_total + total %}
                    {% endfor %}
                    
                    <div class="col-md-4">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <h6 class="card-title">Total de Ventas</h6>
                                <h3>${{ '%.2f' | format(grand_total) }}</h3>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h6 class="card-title">Promedio Semanal</h6>
                                <h3>${{ '%.2f' | format(grand_total / week_totals|length) }}</h3>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <h6 class="card-title">Período</h6>
                                <h3>{{ num_weeks|default(6) }} Semanas</h3>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Check if we have chart data
    const chartData = {{ chart_data|tojson }};
    if (chartData && chartData.length > 0) {
        // Get the chart canvas
        const ctx = document.getElementById('salesChart').getContext('2d');
        
        // Gradient background for the line chart
        const gradientFill = ctx.createLinearGradient(0, 0, 0, 400);
        gradientFill.addColorStop(0, 'rgba(54, 162, 235, 0.8)');
        gradientFill.addColorStop(1, 'rgba(54, 162, 235, 0.1)');
        
        // Define colors for the bars
        const barColors = [
            { bg: 'rgba(255, 99, 132, 0.7)', border: 'rgba(255, 99, 132, 1)' },
            { bg: 'rgba(54, 162, 235, 0.7)', border: 'rgba(54, 162, 235, 1)' },
            { bg: 'rgba(255, 206, 86, 0.7)', border: 'rgba(255, 206, 86, 1)' },
            { bg: 'rgba(75, 192, 192, 0.7)', border: 'rgba(75, 192, 192, 1)' },
            { bg: 'rgba(153, 102, 255, 0.7)', border: 'rgba(153, 102, 255, 1)' },
            { bg: 'rgba(255, 159, 64, 0.7)', border: 'rgba(255, 159, 64, 1)' }
        ];
        
        // Create arrays for bar chart colors
        const backgroundColors = [];
        const borderColors = [];
        
        // Assign colors to the bars
        for (let i = 0; i < chartData.length; i++) {
            const colorIndex = i % barColors.length;
            backgroundColors.push(barColors[colorIndex].bg);
            borderColors.push(barColors[colorIndex].border);
        }
        
        // Chart configuration
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: true,
                    text: 'Ventas Semanales (últimas 6 semanas)',
                    font: {
                        size: 16,
                        weight: 'bold'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleFont: { size: 14 },
                    bodyFont: { size: 14 },
                    callbacks: {
                        label: function(context) {
                            return '$' + context.raw.toFixed(2);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(200, 200, 200, 0.2)' },
                    ticks: {
                        font: { size: 12 },
                        callback: function(value) {
                            return '$' + value.toFixed(2);
                        }
                    },
                    title: {
                        display: true,
                        text: 'Ventas ($)',
                        font: { size: 14, weight: 'bold' }
                    }
                },
                x: {
                    grid: { display: false },
                    ticks: { font: { size: 12 } },
                    title: {
                        display: true,
                        text: 'Semana',
                        font: { size: 14, weight: 'bold' }
                    }
                }
            }
        };
        
        // Common chart data
        const labels = chartData.map(item => item.week);
        const values = chartData.map(item => item.total);
        
        // Create the bar chart by default
        let salesChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Ventas Semanales ($)',
                    data: values,
                    backgroundColor: backgroundColors,
                    borderColor: borderColors,
                    borderWidth: 1
                }]
            },
            options: chartOptions
        });
        
        // Function to switch to bar chart
        document.getElementById('barChartBtn').addEventListener('click', function() {
            // Update active button
            document.getElementById('lineChartBtn').classList.remove('active');
            this.classList.add('active');
            
            // Destroy current chart
            salesChart.destroy();
            
            // Create bar chart
            salesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ventas Semanales ($)',
                        data: values,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 1
                    }]
                },
                options: chartOptions
            });
        });
        
        // Function to switch to line chart
        document.getElementById('lineChartBtn').addEventListener('click', function() {
            // Update active button
            document.getElementById('barChartBtn').classList.remove('active');
            this.classList.add('active');
            
            // Destroy current chart
            salesChart.destroy();
            
            // Create line chart
            salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ventas Semanales ($)',
                        data: values,
                        fill: true,
                        backgroundColor: gradientFill,
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        tension: 0.4  // Smooth curve
                    }]
                },
                options: chartOptions
            });
        });
    }
});
</script>
{% endblock %}