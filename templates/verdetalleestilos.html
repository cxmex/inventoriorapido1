{% if step == "analytics" %}
<script>
// Minimal test - hardcoded data first
console.log('=== MINIMAL CHART TEST ===');
console.log('Chart available?', typeof Chart);
console.log('Canvas exists?', document.getElementById('salesTrendChart') !== null);

// Wait for DOM to be fully loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, attempting chart creation...');
    
    const canvas = document.getElementById('salesTrendChart');
    if (!canvas) {
        console.error('Canvas not found after DOM load!');
        return;
    }
    
    console.log('Canvas found:', canvas);
    
    // Try with simple hardcoded data first
    const testData = {
        labels: ['2025-09-01', '2025-09-02', '2025-09-03'],
        datasets: [{
            label: 'Test Model',
            data: [100, 200, 150],
            borderColor: '#FF6384',
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            tension: 0.4,
            borderWidth: 2
        }]
    };
    
    console.log('Creating chart with test data...');
    
    try {
        const ctx = canvas.getContext('2d');
        console.log('Got canvas context:', ctx);
        
        const chart = new Chart(ctx, {
            type: 'line',
            data: testData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Test Chart'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
        
        console.log('SUCCESS: Chart created!', chart);
        
        // Now try with your actual data
        setTimeout(() => {
            console.log('Destroying test chart, creating real chart...');
            chart.destroy();
            createRealChart();
        }, 2000);
        
    } catch (error) {
        console.error('ERROR creating chart:', error);
    }
});

function createRealChart() {
    console.log('Creating real chart with template data...');
    
    // Your actual data
    const rawData = [
        {% if analytics_data and analytics_data.daily_data %}
        {% for row in analytics_data.daily_data %}
        {
            fecha: "{{ row.fecha.strftime('%Y-%m-%d') if row.fecha else '' }}",
            modelo: "{{ row.modelo }}",
            ingresos: {{ row.daily_revenue or 0 }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
        {% endif %}
    ];
    
    console.log('Template data:', rawData);
    
    if (rawData.length === 0) {
        console.log('No template data available');
        return;
    }
    
    // Process data
    const fechasSet = new Set();
    const modelosSet = new Set();
    
    rawData.forEach(item => {
        if (item.fecha) fechasSet.add(item.fecha);
        if (item.modelo) modelosSet.add(item.modelo);
    });
    
    const fechas = Array.from(fechasSet).sort();
    const modelos = Array.from(modelosSet);
    
    console.log('Processed dates:', fechas);
    console.log('Processed models:', modelos);
    
    // Create revenue map
    const revenueMap = new Map();
    rawData.forEach(item => {
        const key = `${item.modelo}|${item.fecha}`;
        revenueMap.set(key, (revenueMap.get(key) || 0) + item.ingresos);
    });
    
    // Create datasets
    const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'];
    const datasets = modelos.map((modelo, index) => {
        const data = fechas.map(fecha => revenueMap.get(`${modelo}|${fecha}`) || 0);
        return {
            label: modelo,
            data: data,
            borderColor: colors[index % colors.length],
            tension: 0.4,
            borderWidth: 2
        };
    });
    
    console.log('Final datasets:', datasets);
    
    // Create real chart
    const canvas = document.getElementById('salesTrendChart');
    const ctx = canvas.getContext('2d');
    
    const realChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: fechas,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Real Sales Data'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
    
    console.log('Real chart created:', realChart);
}

console.log('=== SCRIPT LOADED ===');
</script>
{% endif %}