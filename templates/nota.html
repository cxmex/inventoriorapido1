<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nota - Test</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .row { display: flex; gap: 10px; margin: 10px 0; align-items: center; }
    .btn { padding: 8px 15px; border: 1px solid #ccc; background: #f5f5f5; cursor: pointer; }
    input[type="text"] { padding: 8px; width: 300px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    .loyalty-row { background-color: #e8f5e9; }
    .discount-row { background-color: #fff3e0; }
    .status { margin-left: 10px; color: #666; }
    .error { color: red; }
    .success { color: green; }
  </style>
</head>
<body>
  <h1>Nota - Test Version</h1>
  
  <div class="row">
    <input id="barcode" type="text" placeholder="Escanea o ingresa código..." autofocus />
    <button id="btn-add" class="btn">Buscar</button>
    <span id="status" class="status"></span>
  </div>

  <table>
    <thead>
      <tr>
        <th>Cantidad</th>
        <th>Producto</th>
        <th>Código</th>
        <th>Precio</th>
        <th>Subtotal</th>
        <th>Acción</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
    <tfoot>
      <tr>
        <td colspan="4"><strong>TOTAL</strong></td>
        <td id="total"><strong>$0.00</strong></td>
        <td></td>
      </tr>
    </tfoot>
  </table>

  <div class="row">
    <button id="btn-save" class="btn">Guardar Venta</button>
    <span id="save-msg" class="status"></span>
  </div>

  <script>
    const barcodeInput = document.getElementById('barcode');
    const statusEl = document.getElementById('status');
    const tbody = document.getElementById('tbody');
    const totalEl = document.getElementById('total');
    const addBtn = document.getElementById('btn-add');
    const saveBtn = document.getElementById('btn-save');
    const saveMsg = document.getElementById('save-msg');

    function fmt(n) { 
      return '$' + Number(n || 0).toFixed(2); 
    }

    function recalcTotal() {
      let total = 0;
      tbody.querySelectorAll('tr').forEach(tr => {
        const qty = parseInt(tr.querySelector('.qty').value || 0);
        const price = parseFloat(tr.querySelector('.price').value || 0);
        const subtotal = qty * price;
        tr.querySelector('.subtotal').textContent = fmt(subtotal);
        total += subtotal;
      });
      totalEl.innerHTML = '<strong>' + fmt(total) + '</strong>';
    }

    function addProductRow(data) {
      const tr = document.createElement('tr');
      
      // Check if it's a loyalty barcode
      const isLoyalty = data.is_loyalty || false;
      const isDiscount = data.price < 0;
      
      if (isLoyalty) {
        tr.className = isDiscount ? 'discount-row' : 'loyalty-row';
        if (data.customer_email) {
          tr.setAttribute('data-customer-email', data.customer_email);
        }
      }
      
      tr.innerHTML = `
        <td><input type="number" class="qty" value="1" min="1" style="width:60px" ${isLoyalty ? 'readonly' : ''}></td>
        <td><input type="text" class="name" value="${data.name || ''}" style="width:200px" ${isLoyalty ? 'readonly' : ''}></td>
        <td class="codigo">${data.codigo || ''}</td>
        <td><input type="number" class="price" value="${(data.price || 0).toFixed(2)}" step="0.01" style="width:80px" ${isLoyalty ? 'readonly' : ''}></td>
        <td class="subtotal">${fmt(data.price || 0)}</td>
        <td><button class="btn" onclick="removeRow(this)">Quitar</button></td>
      `;
      
      tbody.appendChild(tr);
      
      // Add event listeners
      tr.querySelector('.qty').addEventListener('input', recalcTotal);
      tr.querySelector('.price').addEventListener('input', recalcTotal);
      
      recalcTotal();
    }

    function removeRow(btn) {
      btn.closest('tr').remove();
      recalcTotal();
    }

    async function searchBarcode() {
      const barcode = barcodeInput.value.trim();
      if (!barcode) return;
      
      statusEl.textContent = 'Buscando...';
      statusEl.className = 'status';
      
      try {
        console.log('Searching for barcode:', barcode);
        
        const response = await fetch(`/api/search_barcode?barcode=${encodeURIComponent(barcode)}`);
        const data = await response.json();
        
        console.log('API Response:', data);
        
        if (!response.ok) {
          throw new Error(data.detail || 'Error en la búsqueda');
        }
        
        // Add to table
        addProductRow(data);
        
        if (data.is_loyalty) {
          statusEl.textContent = `Cliente: ${data.customer_email} - Saldo: ${fmt(Math.abs(data.price))}`;
          statusEl.className = 'status success';
        } else {
          statusEl.textContent = 'Producto agregado';
          statusEl.className = 'status success';
        }
        
        barcodeInput.value = '';
        // ⭐ NEW: Trigger camera capture (fire and forget - don't wait for it)
        fetch(`/api/start_camera_capture?barcode=${encodeURIComponent(barcode)}`, {
          method: 'POST'
        }).catch(err => console.error('Camera capture error:', err));
        
      } catch (error) {
        console.error('Search error:', error);
        statusEl.textContent = `Error: ${error.message}`;
        statusEl.className = 'status error';
      }
      
      setTimeout(() => {
        if (statusEl.className.includes('success')) {
          statusEl.textContent = '';
        }
      }, 3000);
    }

    function getProducts() {
      const products = [];
      tbody.querySelectorAll('tr').forEach(tr => {
        const product = {
          qty: parseInt(tr.querySelector('.qty').value || 0),
          name: tr.querySelector('.name').value || '',
          codigo: tr.querySelector('.codigo').textContent.trim(),
          price: parseFloat(tr.querySelector('.price').value || 0)
        };
        
        const customerEmail = tr.getAttribute('data-customer-email');
        if (customerEmail) {
          product.customer_email = customerEmail;
        }
        
        products.push(product);
      });
      return products;
    }

    async function saveTransaction() {
      const products = getProducts();
      
      if (products.length === 0) {
        saveMsg.textContent = 'Agrega productos primero';
        saveMsg.className = 'status error';
        return;
      }
      
      saveBtn.disabled = true;
      saveMsg.textContent = 'Guardando...';
      saveMsg.className = 'status';
      
      try {
        console.log('Saving products:', products);
        
        const response = await fetch('/api/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ products })
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.detail || 'Error al guardar');
        }
        
        // Download PDF
        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'ticket.pdf';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        
        // Clear table
        tbody.innerHTML = '';
        recalcTotal();
        
        saveMsg.textContent = 'Venta guardada y ticket descargado ✅';
        saveMsg.className = 'status success';
        
      } catch (error) {
        console.error('Save error:', error);
        saveMsg.textContent = `Error: ${error.message}`;
        saveMsg.className = 'status error';
      } finally {
        saveBtn.disabled = false;
        setTimeout(() => {
          if (saveMsg.className.includes('success')) {
            saveMsg.textContent = '';
          }
        }, 3000);
      }
    }

    // Event listeners
    addBtn.addEventListener('click', searchBarcode);
    barcodeInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        searchBarcode();
      }
    });
    saveBtn.addEventListener('click', saveTransaction);

    // Test buttons for debugging
    document.body.insertAdjacentHTML('beforeend', `
      <div style="margin-top: 20px; padding: 10px; background: #f0f0f0; border-radius: 5px;">
        <h3>Test Buttons</h3>
        <button class="btn" onclick="testProduct()">Test Product (7000401241135)</button>
        <button class="btn" onclick="testCustomer()">Test Customer (8000123456780)</button>
        <div style="margin-top: 10px;">
          <strong>Debug Info:</strong>
          <div id="debug" style="font-family: monospace; font-size: 12px; color: #666;"></div>
        </div>
      </div>
    `);

    function testProduct() {
      barcodeInput.value = '7000401241135';
      searchBarcode();
    }

    function testCustomer() {
      barcodeInput.value = '8000123456780';
      searchBarcode();
    }

    // Debug function to check API status
    async function checkAPI() {
      try {
        const response = await fetch('/health');
        const data = await response.json();
        document.getElementById('debug').innerHTML = `API Status: ${data.status}`;
      } catch (error) {
        document.getElementById('debug').innerHTML = `API Error: ${error.message}`;
      }
    }

    // Check API on load
    checkAPI();
  </script>
</body>
</html>